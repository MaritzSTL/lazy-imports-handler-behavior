<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../lazy-imports/lazy-imports-behavior.html">

<script>

  window.mtz = window.mtz || {};

/**
 * `mtz-lazy-imports-handler-behavior`
 *  Pulls in the Polymer.LazyImportsBehavior and listens for an event to tell an instance of this
 *  behavior to attempt to import a lazy-group within the provided domain. If it is found then it will
 *  stop the event propagation. Listens for events on the use-capture event cycle.
 *
 * @polymerBehavior
 * @demo demo/index.html
 */
  const LazyImportsHandlerBehaviorImpl = {
    properties: {
      /* The domain dictating whether a group can be lazily loaded by this behavior instance */
      domain: {
        type: String,
        value: ''
      },
      groups: {
        type: Set,
        value() {
          return new Set();
        }
      }
    },
    ready() {
      this._importLazyGroup = this._importLazyGroup.bind(this);

      // Gather all groups this element lazily imports
      const thisDomModule = Polymer.DomModule.import(this.localName);
      let groups = new Set();
      if (thisDomModule) {
        const links = Array.from(thisDomModule.
          querySelectorAll(`link[rel=\'lazy-import\'][href]:not([href=\'\']`));
        groups = new Set(links.map((link) => {
          return link.getAttribute('group') || '';
        }));
      }
      this.groups = groups;
    },
    attached() {
      this.addEventListener('import-lazy-group', this._importLazyGroup, true);
    },
    detached() {
      this.removeEventListener('import-lazy-group', this._importLazyGroup, true);
    },

    /**
     * Import lazy group provided that the domain of the group matches the registered domain
     *  of this behavior.
     * @protected
     * @param {CustomEvent} event - The event being processed. This event should include a domain
     * and a group specified in the event.detail property.
     */
    _importLazyGroup(event) {
      const {detail = {}} = event;
      if (detail && this.groups.has(detail.group) && this._isValidDomain(detail.domain)) {
        event.stopImmediatePropagation();
        this.importLazyGroup(detail.group);
      }
    },

    /**
     * Check if a given domain is valid.
     * @param {String} domain - The domain for which a validity check is being done.
     * @return {Boolean} - Returns true if the domain is equavalent to that registered and
     * is not null. Otherwise, return false.
     */
    _isValidDomain(domain) {
      return domain === this.domain;
    }
};

/* @polymerBehavior */
mtz.LazyImportsHandlerBehavior = [Polymer.LazyImportsBehavior, LazyImportsHandlerBehaviorImpl];

</script>
